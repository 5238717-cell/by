# 自动交易流程使用指南

## 概述

系统已优化，支持完整的**开仓→持仓跟踪→止盈平仓→收益计算**自动化流程。当您提供开仓信息后，系统会自动下单并跟踪持仓；当您后续发送止盈信息时，系统会自动平仓并计算收益率。

## 功能特性

### ✅ 核心能力

1. **自动开仓并跟踪**
   - 在币安交易所执行开仓订单
   - 自动创建持仓跟踪记录
   - 记录开仓价格、数量、止盈价格等

2. **智能识别指令**
   - 自动识别开仓/买入指令
   - 自动识别止盈/平仓指令
   - 支持多种表达方式

3. **自动平仓并计算**
   - 根据止盈信息自动平仓
   - 获取实际成交价格
   - 计算收益金额和收益率

4. **完整的持仓管理**
   - 查询未平仓持仓
   - 查看历史交易记录
   - 累计收益统计

## 使用流程

### 步骤1：开仓并开始跟踪

**指令示例：**

```
买入BTC现货，数量0.001，限价单价格90000，止盈92000
```

**系统执行：**
1. 在币安现货买入0.001个BTC，价格90000
2. 创建持仓跟踪记录
3. 返回持仓ID: BTCUSDT-BUY-xxxxx

**返回结果：**
```
✅ 已完成自动开仓并跟踪

| 项目 | 结果 |
| --- | --- |
| 币安限价单 | 已成交（订单ID: 16499409） |
| 成交价格 | 90,000 USDT/BTC |
| 成交数量 | 0.001 BTC |
| 持仓ID | BTCUSDT-BUY-1767166964 |
| 开仓价值 | 90 USDT |
| 止盈价 | 92,000 USDT（+2,000 USDT，约+2.22%） |

下一步：当 BTC 价格 ≥ 92,000 时，直接发送 "BTC止盈了，价格92000"
系统将自动平仓并计算收益。
```

### 步骤2：止盈平仓（当达到目标价格时）

**指令示例：**

```
BTC止盈了，价格92000，止盈平仓
```

**系统执行：**
1. 在币安现货卖出0.001个BTC，价格92000
2. 更新持仓记录为已平仓
3. 计算收益金额和收益率

**返回结果：**
```
✅ BTC 止盈平仓完成

| 项目 | 结果 |
| --- | --- |
| 币安卖单 | 已成交（订单ID: 16499493） |
| 平仓价格 | 92,000 USDT/BTC |
| 收益金额 | +2.00 USDT |
| 收益率 | +2.22% |
| 持仓状态 | 已平仓并归档 |

小结：
0.001 BTC 现货限价单从 90,000 → 92,000 止盈，净赚 2 USDT，全程自动化完成。
```

### 步骤3：查询历史记录

**指令示例：**

```
查询交易历史记录
```

**返回结果：**
```
📜 交易历史记录（最近 20 条内）

| # | 持仓ID | 交易对 | 方向 | 开仓价 | 平仓价 | 收益 | 收益率 | 平仓原因 | 平仓时间 |
|---|---|---|---|---|---|---|---|---|---|
| 1 | BTCUSDT-BUY-xxxxx | BTCUSDT | BUY | 90,000 | 92,000 | +2.00 USDT | +2.22% | 止盈平仓 | 2025-12-31 15:43:41 |

累计收益：+2.00 USDT（1 笔已平仓）
```

## 支持的指令格式

### 开仓指令

**格式1（完整版）：**
```
买入BTC现货，数量0.001，限价单价格90000，止盈92000，止损88000
```

**格式2（简化版）：**
```
BTC，做多，0.001个，90000，止盈92000
```

**格式3（关键词版）：**
```
开仓跟踪：BTC现货，数量0.001，价格90000，止盈92000
```

**支持的关键词：**
- 开仓：买入、做多、开仓、入场、建仓、BUY、LONG
- 交易类型：现货、期货、spot、futures
- 订单类型：市价单、限价单、MARKET、LIMIT

### 止盈/平仓指令

**格式1（完整版）：**
```
BTC止盈了，价格92000，止盈平仓
```

**格式2（简化版）：**
```
BTC平仓，价格92000
```

**格式3（关键词版）：**
```
止盈：BTC，价格92000
```

**支持的关键词：**
- 止盈：止盈、平仓、离场、出局、卖出
- 平仓原因：止盈平仓、止损平仓、手动平仓

### 查询指令

```
查询未平仓持仓
查询交易历史记录
查询历史持仓，最近10条
```

## 高级功能

### 1. 期货交易

```
开仓BTC期货，做多，数量50USDT，2倍杠杆，限价单价格90000，止盈92000
```

### 2. 做空交易

```
做空BTC，数量0.001，价格90000，止盈88000
```

### 3. 市价单（快速成交）

```
买入BTC，数量0.001，市价单，止盈92000
```

**注意：** 市价单可能无法准确记录成交价格，建议优先使用限价单。

### 4. 设置止损

```
买入BTC，数量0.001，限价单价格90000，止盈92000，止损88000
```

## 收益计算

### 计算公式

**现货交易：**
```
收益金额 = (平仓价格 - 开仓价格) × 持仓数量
收益率 = 收益金额 / 开仓价值 × 100%
```

**期货交易（考虑杠杆）：**
```
收益金额 = (平仓价格 - 开仓价格) × 持仓数量 × 杠杆倍数
收益率 = 收益金额 / 开仓价值 × 100%
```

**做空交易：**
```
收益金额 = (开仓价格 - 平仓价格) × 持仓数量 × 杠杆倍数
```

### 示例

**开仓：**
- 交易对：BTCUSDT
- 方向：买入（BUY）
- 数量：0.001 BTC
- 开仓价格：90,000 USDT
- 开仓价值：90 USDT

**平仓：**
- 平仓价格：92,000 USDT

**收益计算：**
```
收益金额 = (92,000 - 90,000) × 0.001 = 20 USDT
收益率 = 20 / 90 × 100% = 22.22%
```

## 持仓管理

### 查询未平仓持仓

```
查询未平仓持仓
```

返回所有未平仓的持仓信息，包括：
- 持仓ID
- 交易对
- 方向
- 数量
- 开仓价格
- 开仓价值
- 止盈价格
- 止损价格
- 开仓时间

### 查询历史记录

```
查询交易历史记录
查询历史持仓，最近5条
```

返回已平仓的持仓信息，包括：
- 持仓ID
- 交易对
- 方向
- 开仓价格
- 平仓价格
- 收益金额
- 收益率
- 平仓原因
- 平仓时间

## 注意事项

### ⚠️ 重要提醒

1. **优先使用限价单**
   - 限价单可明确记录开仓价格
   - 避免市价单的价格偏差
   - 确保收益计算准确

2. **设置止损价格**
   - 控制风险，避免亏损扩大
   - 建议止损距离开仓价2-5%

3. **合理设置止盈目标**
   - 根据市场情况设置合理的止盈价格
   - 不要过于贪婪，落袋为安

4. **定期检查持仓**
   - 使用"查询未平仓持仓"定期检查
   - 及时处理异常情况

5. **谨慎使用杠杆**
   - 杠杆会放大收益和风险
   - 新手建议不超过5倍杠杆

### 📌 常见问题

**Q1: 为什么市价单的开仓价格显示为0？**

A: 市价单在币安API中不返回确定的成交价格，导致无法准确记录。建议优先使用限价单。

**Q2: 如何处理开仓价格为0的异常持仓？**

A: 清理持仓文件（assets/positions.json）并重新开仓。或手动更新持仓记录。

**Q3: 交易会自动执行吗？**

A: 是的，系统会根据您的指令自动执行：
- 开仓指令：自动在币安下单并创建持仓跟踪
- 止盈指令：自动在币安平仓并计算收益

**Q4: 支持哪些交易对？**

A: 支持币安交易所的所有交易对，如：
- BTCUSDT
- ETHUSDT
- BNBUSDT
- SOLUSDT
- 等等

**Q5: 现货和期货有什么区别？**

A:
- **现货交易**：买卖实际资产，风险相对较低
- **期货交易**：使用杠杆，可以开多开空，风险较高
- 建议新手从现货交易开始

**Q6: 如何查看累计收益？**

A: 使用"查询交易历史记录"命令，系统会自动计算累计收益。

## 最佳实践

### 1. 开仓前检查
- 确认账户余额充足
- 检查API密钥配置正确
- 确认交易类型（现货/期货）

### 2. 设置合理的止盈止损
- 止盈目标：根据市场分析设置
- 止损价格：控制风险在可接受范围内

### 3. 定期复盘
- 查看历史交易记录
- 分析成功和失败的交易
- 优化交易策略

### 4. 风险控制
- 不要把所有资金投入单一交易
- 分散投资降低风险
- 设置合理的杠杆倍数

## 技术支持

如有问题，请：
1. 查看本文档的常见问题部分
2. 检查币安API配置
3. 查看 `docs/binance_api_guide.md` 获取详细配置信息

---

**最后更新：** 2025-12-31
**版本：** 1.0
