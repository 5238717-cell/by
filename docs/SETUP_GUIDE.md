# 飞书群消息监听与多维表格写入 - 配置指南

## 功能说明

本程序可以：
1. **监听飞书群消息**：自动接收指定群聊中的所有消息
2. **智能解析订单信息**：从消息中提取订单类型、开仓方向、入场金额、止盈、止损等关键信息
3. **自动写入多维表格**：将解析后的数据自动写入飞书多维表格

## 重要说明

### 关于 Webhook 地址
您提供的 webhook 地址（`https://open.feishu.cn/open-apis/bot/v2/hook/...`）是用于**发送消息**到群聊的自定义机器人，**不能用于接收群消息**。

要实现**接收群消息**，必须使用飞书的**事件订阅**功能。本程序采用**长连接模式**，无需配置 webhook 或公网 IP。

---

## 第一步：创建飞书企业自建应用

### 1. 登录飞书开放平台
访问：https://open.feishu.cn/app

### 2. 创建企业自建应用
1. 点击「创建企业自建应用」
2. 填写应用名称（如：交易信号监听机器人）
3. 选择可见范围（建议选择全公司）
4. 点击「创建」

### 3. 获取凭证
1. 进入应用详情页
2. 点击「凭证与基础信息」
3. 记录以下信息：
   - **App ID**（例如：`cli_xxxxxxxxxx`）
   - **App Secret**（点击「查看」获取）

---

## 第二步：配置权限和事件订阅

### 1. 开启权限
在应用详情页，进入「权限管理」，开启以下权限：

| 权限名称 | 说明 |
|---------|------|
| `im:message` | 获取与发送消息 |
| `im:message:group_at_msg` | 获取群组中@机器人的消息 |
| `im:message:send_as_bot` | 以机器人身份发送消息（可选） |
| `contact:group:readonly` | 读取群组信息 |

### 2. 配置事件订阅
在应用详情页，进入「事件与回调」：

#### 使用长连接模式（推荐，简单）
1. 点击「添加事件」
2. 搜索并添加以下事件：
   - `im.message.receive_v1`（接收消息）
3. 开启「使用长连接接收事件」开关
4. 点击「保存」

#### 说明
- 长连接模式无需公网 IP 或域名
- 程序会自动建立 WebSocket 连接接收消息
- 适合本地开发和测试

### 3. 发布应用版本
1. 进入「版本管理与发布」
2. 点击「创建新版本」
3. 输入版本说明（如：v1.0 - 初始版本）
4. 点击「保存」
5. 点击「申请发布」

---

## 第三步：将机器人添加到目标群

1. 在飞书中打开目标群聊
2. 点击右上角「...」进入群设置
3. 点击「群机器人」
4. 点击「添加机器人」
5. 选择您创建的企业自建应用（应用名称：交易信号监听机器人）
6. 确认添加

---

## 第四步：创建多维表格

### 1. 创建多维表格
1. 在飞书中创建一个新的多维表格
2. 命名（如：交易信号记录）

### 2. 创建数据表
在多维表格中创建一个数据表，包含以下字段：

| 字段名称 | 字段类型 | 说明 |
|---------|---------|------|
| 群名称 | 文本 | 消息来源群 |
| 消息内容 | 文本 | 原始消息内容 |
| 订单类型 | 文本 | 开仓/平仓/买入/卖出等 |
| 开仓方向 | 文本 | 做多/做空 |
| 入场金额 | 文本 | 入场金额（含单位） |
| 止盈 | 文本 | 止盈价格/比例 |
| 止损 | 文本 | 止损价格/比例 |
| 策略关键词 | 文本 | 策略相关关键词 |

### 3. 获取凭证
1. 在浏览器中打开多维表格
2. 从 URL 中获取 **App Token**：
   - URL 格式：`https://xxxx.feishu.cn/base/{APP_TOKEN}/xxx`
   - 示例：`bascnxxxxxxxxxxxx`
3. 进入数据表，从 URL 或表格设置中获取 **Table ID**：
   - 格式：`tblxxxxxxxxxxxx`

---

## 第五步：配置环境变量

### 方式一：通过环境变量文件（推荐）
在项目根目录创建 `.env` 文件：

```bash
# 飞书应用配置
FEISHU_APP_ID=cli_xxxxxxxxxx
FEISHU_APP_SECRET=xxxxxxxxxxxxxxxxxxxx

# 多维表格配置
FEISHU_BITABLE_APP_TOKEN=bascnxxxxxxxxxxxx
FEISHU_BITABLE_TABLE_ID=tblxxxxxxxxxxxx
```

### 方式二：直接设置环境变量
```bash
export FEISHU_APP_ID=cli_xxxxxxxxxx
export FEISHU_APP_SECRET=xxxxxxxxxxxxxxxxxxxx
export FEISHU_BITABLE_APP_TOKEN=bascnxxxxxxxxxxxx
export FEISHU_BITABLE_TABLE_ID=tblxxxxxxxxxxxx
```

---

## 第六步：运行程序

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 运行程序
```bash
python -m src.main
```

### 3. 观察日志
程序启动后会输出：
```
============================================================
启动飞书群消息监听服务...
============================================================
✓ 长连接已建立，开始监听群消息...
提示: 按 Ctrl+C 停止服务
============================================================
```

### 4. 测试
在目标群中发送包含交易策略的消息，例如：

```
策略：BTC现货交易
做多方向，入场金额：1000U
止盈：20%
止损：10%
```

程序会自动解析并写入多维表格。

---

## 消息格式示例

程序能够识别包含以下关键词的消息：

### 关键词识别
- **订单类型**：开仓、平仓、买入、卖出、做多、做空、入场、离场
- **方向**：做多、做空、买入、卖出、long、short
- **金额**：入场金额、投入、仓位
- **止盈**：止盈、目标、盈利、tp
- **止损**：止损、风控、sl
- **策略**：策略、交易计划

### 消息示例
```
策略：BTC 4小时突破
做多方向，入场金额：500U
入场位置：95000
止盈：98000
止损：94000
```

解析结果：
- 群名称：自动获取
- 订单类型：入场
- 开仓方向：做多
- 入场金额：入场金额：500U
- 止盈：止盈：98000
- 止损：止损：94000
- 策略关键词：BTC 4小时突破

---

## 常见问题

### Q1: 为什么收不到群消息？
**A:** 请检查：
1. 机器人是否已添加到目标群？
2. 应用是否已发布版本？
3. 事件订阅是否已配置并开启长连接模式？
4. 相关权限是否已开启？

### Q2: 提示 "Failed to get access token"
**A:** 这是多维表格集成的认证问题，请确保：
1. `FEISHU_BITABLE_APP_TOKEN` 和 `FEISHU_BITABLE_TABLE_ID` 正确
2. 集成凭证已正确配置（系统自动处理）

### Q3: 消息解析不准确怎么办？
**A:** 可以根据实际情况修改 `src/tools/message_parser.py` 中的正则表达式模式，适配您的实际消息格式。

### Q4: 程序如何持久运行？
**A:** 推荐使用以下方式：
- 使用 `nohup` 或 `screen` 在后台运行
- 使用 systemd 或 supervisord 守护进程
- 部署到云服务器

---

## 文件结构

```
.
├── src/
│   ├── agents/
│   │   └── agent.py          # 主程序
│   ├── tools/
│   │   ├── message_parser.py    # 消息解析模块
│   │   ├── bitable_writer.py    # 多维表格写入模块
│   │   └── feishu_listener.py   # 飞书监听服务
│   └── main.py               # 入口文件
├── assets/
│   └── feishu_listener.log  # 日志文件
├── docs/
│   └── SETUP_GUIDE.md       # 配置指南
├── config/
│   └── .env                 # 环境变量配置
└── requirements.txt         # 依赖列表
```

---

## 技术支持

如有问题，请检查：
1. 日志文件 `assets/feishu_listener.log`
2. 飞书开放平台的「日志检索」功能
3. 确保所有配置信息正确
